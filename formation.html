<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ZAP48 • Formation Admin (BRAT v3)</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --primary:#8ACE00;
      --black:#000;
      --white:#fff;
      --bg:#f4f4f4;
      --border:2px solid #000;
      --shadow:4px 4px 0px #000;
      --shadow-sm:2px 2px 0px #000;
      --radius:16px;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    body{
      background: var(--bg);
      color: var(--black);
      font-family: Roboto, system-ui, Arial;
      padding: 14px 12px 40px;
      overflow-x:hidden;
    }
    h1,h2,h3,.font-head{
      font-family: Montserrat, sans-serif;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: -.4px;
    }

    .wrap{max-width: 1100px; margin:0 auto;}
    .header{
      background: var(--bg);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position: sticky;
      top: 10px;
      z-index: 10;
    }
    .logo{font-family: Montserrat;font-weight: 900;font-size: 1.1rem;font-style: italic; line-height:1;}
    .logo span{ color: var(--primary); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin-top: 12px;
    }

    .card{
      background:#fff;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 12px 12px;
      border-bottom: var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: #fff;
    }
    .cardBody{ padding: 12px; }

    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    input,select,button{
      padding: 10px 12px;
      border: var(--border);
      border-radius: 10px;
      font-weight: 900;
      font-family: Montserrat, sans-serif;
      background:#fff;
      box-shadow: var(--shadow-sm);
    }
    input{ font-family: Roboto, system-ui, Arial; font-weight: 800; }
    button{ cursor:pointer; background: var(--primary); }
    button.alt{ background:#fff; }
    button.danger{ background:#ffb3b3; }
    button:active{ transform: scale(.98); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .hint{
      font-size: 12px;
      font-weight: 900;
      opacity:.75;
    }

    /* ===== FORMATION BOARD ===== */
    .boardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }

    .layoutPills{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .pill{
      border: var(--border);
      box-shadow: var(--shadow-sm);
      border-radius: 999px;
      padding: 8px 12px;
      background:#fff;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{ background: var(--primary); }

    .rows{ display:flex; flex-direction:column; gap:14px; }
    .rowDots{ display:flex; justify-content:center; flex-wrap:wrap; gap:10px; }
    .rowLabel{
      text-align:center;
      margin-top: 6px;
      font-family: Montserrat;
      font-weight: 900;
      font-size: .9rem;
    }

    .dot{
      width: 76px; height: 76px;
      border-radius: 999px;
      border: var(--border);
      box-shadow: var(--shadow-sm);
      background: #fff;
      overflow:hidden;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .dot.selected{
      outline: 4px solid #000;
      outline-offset: 2px;
      transform: translateY(-1px);
    }
    .dot img{
      width:100%;
      height:100%;
      object-fit:cover;
      opacity: 1;
    }
    .dot .q{
      position:absolute;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 26px;
      color:#000;
      opacity:.9;
    }
    .dot .num{
      position:absolute; bottom:0; left:0; right:0;
      text-align:center;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 14px;
      color:#000;
      background: rgba(138,206,0,.92);
      border-top: 2px solid #000;
      padding: 2px 0;
    }
    .dot.filled .q{ display:none; }

    /* multi center */
    .star{
      position:absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid #000;
      background: #ffd700;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      font-weight: 900;
      box-shadow: 2px 2px 0 #000;
      transform: rotate(10deg);
      opacity: 0;
    }
    .dot.center .star{ opacity: 1; }

    .smallBtn{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-family: Montserrat;
    }

    /* ===== MEMBERS LIST ===== */
    .membersBox{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .membersHeader{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .membersHeader input{
      flex: 1;
      min-width: 180px;
    }
    .membersList{
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 10px;
      background:#fff;
      height: 520px;            /* <- limita */
      overflow:auto;            /* <- scroll */
    }
    .memberCard{
      border: var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow-sm);
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      background:#fff;
      margin-bottom: 10px;
      cursor:pointer;
      user-select:none;
    }
    .memberCard:hover{ transform: translateY(-1px); }
    .memberCard img{
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: var(--border);
      object-fit:cover;
      background:#eee;
      flex: 0 0 auto;
    }
    .memberMeta{flex:1; min-width: 0;}
    .memberName{
      font-family: Montserrat;
      font-weight: 900;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: 13px;
      line-height: 1.1;
    }
    .memberSub{font-size: 11px; font-weight: 900; opacity:.75; margin-top: 2px;}
    .tag{
      display:inline-block;
      border: var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 11px;
      background:#fff;
      box-shadow: var(--shadow-sm);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: #fff;
      border: var(--border);
      box-shadow: var(--shadow);
      border-radius: 999px;
      padding: 10px 14px;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 99;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .membersList{ height: 360px; }
      .dot{ width: 70px; height: 70px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="logo">ZAP<span>48</span> <span style="font-style:normal;color:#000">ADMIN</span></div>
    <div class="row">
      <select id="formationSelect"></select>
      <button class="alt" id="newBtn">NOVA</button>
      <button class="danger" id="deleteBtn">DELETAR</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: FORMATION -->
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="font-head" style="font-size:14px">Formação</div>
          <div class="hint" id="statusHint">—</div>
        </div>
        <div class="row">
          <button class="alt smallBtn" id="clearSlotsBtn">LIMPAR SLOTS</button>
          <button class="alt smallBtn" id="clearCentersBtn">LIMPAR CENTERS</button>
        </div>
      </div>

      <div class="cardBody">
        <div class="row" style="margin-bottom:10px">
          <input id="titleInput" placeholder="Título (ex: 2nd Single • formation)" style="flex:1;min-width:220px">
          <input id="singleIdInput" type="number" placeholder="Single ID" style="width:140px">
          <label class="tag" style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="publishedInput" style="box-shadow:none;border:none;width:18px;height:18px">
            PUBLICADO
          </label>
        </div>

        <div class="boardTop">
          <div class="layoutPills">
            <div class="pill active" data-layout="5-4-5">LAYOUT 5-4-5</div>
            <div class="pill" data-layout="5-4-3">LAYOUT 5-4-3</div>
            <div class="pill" data-layout="7-5">LAYOUT 7-5</div>
            <div class="pill" data-layout="custom">CUSTOM</div>
          </div>

          <div class="row">
            <input id="customLayoutInput" placeholder="custom: 5-4-5" style="width:160px" disabled>
            <button class="alt smallBtn" id="applyLayoutBtn">APLICAR</button>
          </div>
        </div>

        <div class="hint" style="margin:6px 0 12px">
          Clique numa <b>posição</b> (bolinha) e depois clique num <b>membro</b> para colocar. ⭐ marca Center (pode ter vários).
        </div>

        <div class="rows" id="boardRows"></div>

        <div class="row" style="margin-top:12px; justify-content:space-between">
          <div class="hint" id="slotHint">Selecione uma posição…</div>
          <div class="row">
            <button class="alt" id="removeFromSlotBtn" disabled>REMOVER DA POSIÇÃO</button>
            <button id="saveBtn">SALVAR</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: MEMBERS -->
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="font-head" style="font-size:14px">Membros</div>
          <div class="hint" id="membersCountHint">—</div>
        </div>
        <div class="row">
          <span class="tag" id="selectedSlotTag">SLOT: —</span>
          <button class="alt smallBtn" id="toggleCenterBtn" disabled>⭐ CENTER</button>
        </div>
      </div>

      <div class="cardBody membersBox">
        <div class="membersHeader">
          <input id="searchInput" placeholder="Buscar membro..." />
          <select id="teamFilter">
            <option value="">Todos os times</option>
          </select>
          <select id="genFilter">
            <option value="">Todas gerações</option>
          </select>
        </div>

        <div class="membersList" id="membersList">
          Carregando...
        </div>

        <div class="hint">
          Dica: se não quiser selecionar slot, clique em um slot primeiro (pra ficar “SLOT: 3”).
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">—</div>
</div>

<script>
/* =========================
   CONFIG (ANON)
   ========================= */
const SUPABASE_URL = "https://iooyygtaosshxygnhlco.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvb3l5Z3Rhb3NzaHh5Z25obGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDEyNTUsImV4cCI6MjA4NDU3NzI1NX0.gfcVtNgn3g1gnFVrtaIqzkWxajYiV_KbtycYsE9OZ0Y";


/* tabelas */
const TABLE_MEMBERS = "Membros";
const TABLE_FORMATION = "formation_machine";

/* =========================
   REFS
   ========================= */
const formationSelect = document.getElementById("formationSelect");
const newBtn = document.getElementById("newBtn");
const deleteBtn = document.getElementById("deleteBtn");

const titleInput = document.getElementById("titleInput");
const singleIdInput = document.getElementById("singleIdInput");
const publishedInput = document.getElementById("publishedInput");

const statusHint = document.getElementById("statusHint");

const pills = [...document.querySelectorAll(".pill")];
const customLayoutInput = document.getElementById("customLayoutInput");
const applyLayoutBtn = document.getElementById("applyLayoutBtn");

const boardRows = document.getElementById("boardRows");
const slotHint = document.getElementById("slotHint");
const selectedSlotTag = document.getElementById("selectedSlotTag");

const clearSlotsBtn = document.getElementById("clearSlotsBtn");
const clearCentersBtn = document.getElementById("clearCentersBtn");
const removeFromSlotBtn = document.getElementById("removeFromSlotBtn");
const toggleCenterBtn = document.getElementById("toggleCenterBtn");

const saveBtn = document.getElementById("saveBtn");

const membersList = document.getElementById("membersList");
const membersCountHint = document.getElementById("membersCountHint");
const searchInput = document.getElementById("searchInput");
const teamFilter = document.getElementById("teamFilter");
const genFilter = document.getElementById("genFilter");

const toast = document.getElementById("toast");

/* =========================
   STATE
   ========================= */
let sb = null;

let membersDB = [];       // membros do banco
let formations = [];      // formations list
let editingId = null;     // formation id selecionada

// layout = array por row (row 1 frente)
let layout = [5,4,5];

// slots = posições do layout
// slot: { row, seat, posNo, member: {id,name,photo_url}, is_center, reveal_order }
let slots = [];
let selectedSlotIndex = null;

/* =========================
   HELPERS
   ========================= */
function toastMsg(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1400);
}
function safeUpper(s){ return String(s||"").toUpperCase(); }

function parseLayout(str){
  const parts = String(str||"")
    .split("-")
    .map(x=>x.trim())
    .filter(Boolean)
    .map(x=>Number(x))
    .filter(n=>Number.isFinite(n) && n>0 && n<=30);
  return parts.length ? parts : null;
}

function setLayout(next){
  layout = next;
  buildSlotsFromLayout();
  renderBoard();
  selectSlot(null);
}

function buildSlotsFromLayout(){
  slots = [];
  let posNo = 1;
  for(let r=1; r<=layout.length; r++){
    const count = layout[r-1];
    for(let seat=1; seat<=count; seat++){
      slots.push({
        row: r,
        seat,
        posNo,
        member: null,
        is_center: false,
        reveal_order: posNo // default: revela por posição
      });
      posNo++;
    }
  }
}

function selectSlot(index){
  selectedSlotIndex = index;
  if(index === null || index === undefined){
    slotHint.textContent = "Selecione uma posição…";
    selectedSlotTag.textContent = "SLOT: —";
    removeFromSlotBtn.disabled = true;
    toggleCenterBtn.disabled = true;
    return;
  }
  const s = slots[index];
  slotHint.textContent = `Posição ${s.posNo} • Row ${s.row} • Seat ${s.seat}`;
  selectedSlotTag.textContent = `SLOT: ${s.posNo}`;
  removeFromSlotBtn.disabled = !s.member;
  toggleCenterBtn.disabled = false;
  toggleCenterBtn.textContent = s.is_center ? "⭐ CENTER (ON)" : "⭐ CENTER";
}

function setMemberOnSelectedSlot(member){
  if(selectedSlotIndex === null || selectedSlotIndex === undefined){
    toastMsg("Selecione um SLOT primeiro");
    return;
  }
  slots[selectedSlotIndex].member = {
    id: member.id,
    name: member.Nome,
    photo_url: member.Foto
  };
  renderBoard();
  selectSlot(selectedSlotIndex);
}

function removeMemberFromSelectedSlot(){
  if(selectedSlotIndex === null) return;
  slots[selectedSlotIndex].member = null;
  renderBoard();
  selectSlot(selectedSlotIndex);
}

function toggleCenterOnSelectedSlot(){
  if(selectedSlotIndex === null) return;
  slots[selectedSlotIndex].is_center = !slots[selectedSlotIndex].is_center;
  renderBoard();
  selectSlot(selectedSlotIndex);
}

/* =========================
   RENDER BOARD
   ========================= */
function renderBoard(){
  // agrupa por row (trás em cima no board)
  const maxRow = layout.length;
  const htmlRows = [];
  for(let r=maxRow; r>=1; r--){
    const rowSlots = slots
      .filter(s=>s.row===r)
      .sort((a,b)=>a.seat-b.seat);

    const dots = rowSlots.map(s=>{
      const idx = slots.indexOf(s);
      const filled = !!s.member;
      const sel = (selectedSlotIndex===idx) ? "selected" : "";
      const center = s.is_center ? "center" : "";
      const cls = `dot ${filled?"filled":""} ${sel} ${center}`;
      const img = filled ? `<img src="${s.member.photo_url}" alt="">` : "";
      return `
        <div class="${cls}" data-idx="${idx}">
          ${img}
          <div class="q">?</div>
          <div class="star">★</div>
          <div class="num">${s.posNo}</div>
        </div>
      `;
    }).join("");

    htmlRows.push(`
      <div>
        <div class="rowDots">${dots}</div>
        <div class="rowLabel">${r}列目</div>
      </div>
    `);
  }

  boardRows.innerHTML = htmlRows.join("");

  // click handlers
  boardRows.querySelectorAll(".dot").forEach(el=>{
    el.addEventListener("click", ()=>{
      const idx = Number(el.dataset.idx);
      selectSlot(idx);
      // marca visual
      renderBoard(); // simples e direto
    });
  });
}

/* =========================
   RENDER MEMBERS (limitado)
   ========================= */
function buildFilters(){
  // Team e Geração vindo da tabela
  const teams = [...new Set(membersDB.map(m=>m.Time).filter(Boolean))].sort();
  const gens  = [...new Set(membersDB.map(m=>m.Geracao).filter(Boolean))].sort();

  teamFilter.innerHTML = `<option value="">Todos os times</option>` +
    teams.map(t=>`<option value="${t}">${t}</option>`).join("");

  genFilter.innerHTML = `<option value="">Todas gerações</option>` +
    gens.map(g=>`<option value="${g}">${g}</option>`).join("");
}

function renderMembers(){
  const q = (searchInput.value||"").trim().toLowerCase();
  const team = teamFilter.value;
  const gen = genFilter.value;

  const filtered = membersDB.filter(m=>{
    const nameOk = !q || String(m.Nome||"").toLowerCase().includes(q);
    const teamOk = !team || String(m.Time||"")===team;
    const genOk = !gen || String(m.Geracao||"")===gen;
    return nameOk && teamOk && genOk;
  });

  membersCountHint.textContent = `${filtered.length} membros (filtrado)`;

  // render
  membersList.innerHTML = filtered.map(m=>`
    <div class="memberCard" data-id="${m.id}">
      <img src="${m.Foto || ""}" alt="" onerror="this.src='https://via.placeholder.com/52?text=?'">
      <div class="memberMeta">
        <div class="memberName">${safeUpper(m.Nome)}</div>
        <div class="memberSub">${m.Time || "—"} • ${m.Geracao || "—"} • ID ${m.id}</div>
      </div>
      <span class="tag">ADD</span>
    </div>
  `).join("") || `<div class="hint">Nenhum membro encontrado.</div>`;

  membersList.querySelectorAll(".memberCard").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = Number(el.dataset.id);
      const member = membersDB.find(x=>x.id===id);
      if(!member) return;
      setMemberOnSelectedSlot(member);
      toastMsg(`ADD: ${member.Nome}`);
    });
  });
}

/* =========================
   LOAD MEMBERS
   ========================= */
async function loadMembers(){
  const { data, error } = await sb
    .from(TABLE_MEMBERS)
    .select("id, Nome, Foto, Time, Geracao")
    .order("Nome");

  if(error){
    console.error(error);
    membersList.innerHTML = `<div class="hint" style="color:red">Erro ao carregar membros: ${error.message}</div>`;
    return;
  }

  membersDB = data || [];
  buildFilters();
  renderMembers();
}

/* =========================
   FORMATIONS CRUD
   ========================= */
async function loadFormations(){
  formationSelect.innerHTML = `<option value="">Carregando...</option>`;
  const { data, error } = await sb
    .from(TABLE_FORMATION)
    .select("id, title, single_id, members, published")
    .order("single_id", { ascending: true });

  if(error){
    console.error(error);
    formationSelect.innerHTML = `<option value="">Erro</option>`;
    toastMsg("Erro ao carregar formations");
    return;
  }

  formations = data || [];

  if(formations.length === 0){
    formationSelect.innerHTML = `<option value="">(sem formations)</option>`;
    editingId = null;
    statusHint.textContent = "Nenhuma formation ainda.";
    return;
  }

  formationSelect.innerHTML = formations.map(f=>{
    const label = f.single_id ? `${f.single_id}th • ${f.title || "formation"}` : `ID ${f.id}`;
    return `<option value="${f.id}">${label}</option>`;
  }).join("");

  formationSelect.value = formations[0].id;
  await loadFormationById(formations[0].id);
}

function clearInputsForNew(){
  editingId = null;
  titleInput.value = "";
  singleIdInput.value = "";
  publishedInput.checked = false;
  statusHint.textContent = "Nova formation (não salva).";
  setLayout(layout); // mantém layout atual, limpa slots
}

async function loadFormationById(id){
  const f = formations.find(x=>String(x.id)===String(id));
  if(!f){
    clearInputsForNew();
    return;
  }

  editingId = f.id;
  titleInput.value = f.title || "";
  singleIdInput.value = f.single_id ?? "";
  publishedInput.checked = !!f.published;

  // slots base no layout detectado pela formação (se conseguir)
  // tenta deduzir layout pela contagem por row
  const arr = Array.isArray(f.members) ? f.members : [];
  const counts = {};
  arr.forEach(m=>{
    const r = Number(m.row || 1);
    counts[r] = (counts[r]||0) + 1;
  });

  const rowsAsc = Object.keys(counts).map(Number).sort((a,b)=>a-b);
  if(rowsAsc.length){
    const guessed = rowsAsc.map(r=>counts[r]);
    layout = guessed;
    // atualizar pills ui
    pills.forEach(p=>p.classList.toggle("active", p.dataset.layout==="custom"));
    customLayoutInput.disabled = false;
    customLayoutInput.value = guessed.join("-");
  }

  buildSlotsFromLayout();

  // preencher slots por row/seat
  for(const m of arr){
    const row = Number(m.row||1);
    const seat = Number(m.seat||1);
    const slot = slots.find(s=>s.row===row && s.seat===seat);
    if(!slot) continue;
    slot.member = {
      id: m.id,
      name: m.name,
      photo_url: m.photo_url
    };
    slot.is_center = !!m.is_center;
    slot.reveal_order = Number(m.reveal_order || slot.posNo);
  }

  renderBoard();
  selectSlot(null);

  statusHint.textContent = `Editando ID ${editingId}`;
}

function makePayload(){
  const title = titleInput.value.trim();
  const singleId = Number(singleIdInput.value);

  if(!title || !Number.isFinite(singleId)){
    toastMsg("Preencha Título e Single ID");
    return null;
  }

  // monta array members somente slots preenchidos
  const filled = slots.filter(s=>!!s.member).map(s=>({
    id: s.member.id,
    name: s.member.name,
    photo_url: s.member.photo_url,
    row: s.row,
    seat: s.seat,
    reveal_order: s.reveal_order ?? s.posNo,
    is_center: !!s.is_center
  }));

  // dica: você pode permitir slots vazios, mas pro view ficar certinho
  // é melhor ter todo mundo preenchido
  const totalSlots = slots.length;
  if(filled.length !== totalSlots){
    // não bloqueia, só avisa
    statusHint.textContent = `⚠️ Ainda faltam ${totalSlots - filled.length} posições vazias`;
  }

  return {
    title,
    single_id: singleId,
    published: !!publishedInput.checked,
    members: filled
  };
}

async function saveFormation(){
  const payload = makePayload();
  if(!payload) return;

  let res;
  if(editingId){
    res = await sb.from(TABLE_FORMATION).update(payload).eq("id", editingId);
  } else {
    res = await sb.from(TABLE_FORMATION).insert(payload);
  }

  if(res.error){
    console.error(res.error);
    toastMsg("Erro ao salvar");
    statusHint.textContent = `Erro: ${res.error.message}`;
    return;
  }

  toastMsg("Salvo ✓");
  statusHint.textContent = "Salvo com sucesso ✓";
  await loadFormations(); // recarrega list
}

async function deleteFormation(){
  if(!editingId){
    toastMsg("Nada pra deletar");
    return;
  }
  const ok = confirm("Deletar essa formation? (não tem volta)");
  if(!ok) return;

  const res = await sb.from(TABLE_FORMATION).delete().eq("id", editingId);
  if(res.error){
    console.error(res.error);
    toastMsg("Erro ao deletar");
    return;
  }

  toastMsg("Deletado ✓");
  await loadFormations();
}

/* =========================
   UI EVENTS
   ========================= */
pills.forEach(p=>{
  p.addEventListener("click", ()=>{
    pills.forEach(x=>x.classList.remove("active"));
    p.classList.add("active");

    const key = p.dataset.layout;
    if(key==="custom"){
      customLayoutInput.disabled = false;
      customLayoutInput.focus();
      return;
    }
    customLayoutInput.disabled = true;

    const map = {
      "5-4-5":[5,4,5],
      "5-4-3":[5,4,3],
      "7-5":[7,5]
    };
    setLayout(map[key] || [5,4,5]);
    statusHint.textContent = `Layout: ${layout.join("-")}`;
  });
});

applyLayoutBtn.addEventListener("click", ()=>{
  const activeCustom = pills.some(p=>p.dataset.layout==="custom" && p.classList.contains("active"));
  if(!activeCustom){
    toastMsg("Selecione CUSTOM primeiro");
    return;
  }
  const parsed = parseLayout(customLayoutInput.value);
  if(!parsed){
    toastMsg("Layout inválido (ex: 5-4-5)");
    return;
  }
  setLayout(parsed);
  statusHint.textContent = `Layout: ${layout.join("-")}`;
});

newBtn.addEventListener("click", ()=>{
  clearInputsForNew();
  toastMsg("Nova formation");
});

deleteBtn.addEventListener("click", deleteFormation);

formationSelect.addEventListener("change", async ()=>{
  const id = formationSelect.value;
  if(!id) return;
  await loadFormationById(id);
});

saveBtn.addEventListener("click", saveFormation);

clearSlotsBtn.addEventListener("click", ()=>{
  slots.forEach(s=>s.member=null);
  renderBoard();
  selectSlot(null);
  toastMsg("Slots limpos");
});

clearCentersBtn.addEventListener("click", ()=>{
  slots.forEach(s=>s.is_center=false);
  renderBoard();
  selectSlot(selectedSlotIndex);
  toastMsg("Centers limpos");
});

removeFromSlotBtn.addEventListener("click", ()=>{
  removeMemberFromSelectedSlot();
  toastMsg("Removido");
});

toggleCenterBtn.addEventListener("click", ()=>{
  toggleCenterOnSelectedSlot();
  toastMsg("Center alternado");
});

searchInput.addEventListener("input", renderMembers);
teamFilter.addEventListener("change", renderMembers);
genFilter.addEventListener("change", renderMembers);

/* =========================
   INIT
   ========================= */
(function init(){
  if(typeof window.supabase === "undefined"){
    statusHint.textContent = "Supabase não carregou";
    membersList.textContent = "Supabase não carregou";
    return;
  }
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("COLE_")){
    statusHint.textContent = "Cole SUPABASE_URL e SUPABASE_ANON_KEY no topo";
    membersList.textContent = "Faltam chaves (cole no topo do arquivo)";
    return;
  }
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  buildSlotsFromLayout();
  renderBoard();
  selectSlot(null);

  statusHint.textContent = "Carregando dados…";
  loadMembers().then(()=>{
    loadFormations().then(()=>{
      statusHint.textContent = "Pronto ✓";
    });
  });
})();
</script>
</body>
</html>
